<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateurs üìä</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="media/Logo/logo.ico" type="image/x-icon">
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5QFGNT3V2F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5QFGNT3V2F');
</script>
<body>
    <header>
        <a href="index.html" class="logo-title-link">
            <img src="./media/Logo/Logo-White.png" alt="Logo QualityInvest">
            <h1>StocksPickeur</h1>
        </a>
        <div class="onglets">
            <a href="calculator.html">Calculateur</a>
            <a href="resources.html">Ressources</a>
            <a href="wallet.html">Portefeuille</a>
        </div>
    </header>

    <div class="calculator-home">

        <h2 class="title-home">Score de Qualit√© üìä</h2>
        <p class="calculator-text-home">Bienvenue sur mon outil de calcul du score de qualit√© d‚Äôune action ! Ce calcul repose sur une analyse approfondie de 15 crit√®res financiers et strat√©giques sp√©cifiques, qui permettent d‚Äô√©valuer solidit√©,croissance et rentabilit√© d‚Äôune action. Chaque crit√®re est pond√©r√© et contribue √† un score global sur 30 points. <br> Ce score vous permettra de mieux comprendre les forces et faiblesses d‚Äôune action afin de prendre des d√©cisions d‚Äôinvestissement plus √©clair√©es. Ce sont les 15 crit√®res que j'utilise √† l'heure actuelle pour analyser mes propres actions. Vous pouvez retrouver le score des actions de mon portefeuille ici : <a class="link-to-wallet" href="./wallet.html#quality">Score de qualit√© des actions de mon Portefeuille ‚öîÔ∏è</a> </p>
        <div class="ticker-input-container">
            <input type="text" id="stockTicker" class="ticker-input" placeholder="Entrez le ticker (ex: AAPL)" autocomplete="off">
            <div class="safety-margin-container">
                <label>Marge de s√©curit√©: <span id="safetyMarginValue">10</span>%</label>
                <div class="slider-container">
                    <div class="slider-track">
                        <div class="slider-fill"></div>
                        <input type="range" min="0" max="6" value="2" step="1" class="slider" list="markers" id="safetyMarginSlider">
                        <div class="slider-marks">
                            <span class="mark" style="left: 0%">0%</span>
                            <span class="mark" style="left: 16.66%">5%</span>
                            <span class="mark" style="left: 33.33%">10%</span>
                            <span class="mark" style="left: 50%">15%</span>
                            <span class="mark" style="left: 66.66%">20%</span>
                            <span class="mark" style="left: 83.33%">30%</span>
                            <span class="mark" style="left: 100%">50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="bases">
            <h3 class="calculator-section">BASES</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="V√©rifie si l'action a perform√© mieux que l'indice S&P 500 sur les 5 derni√®res ann√©es.">COURS DE L'ACTION BATS LE S&P500 SUR 5 ANS</p>
                    <input type="text" class="calc-input" placeholder="Oui/Non">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="L'entreprise rach√®te-t-elle ses propres actions ?">L'ENTREPRISE EFFECTUE DES RACHATS D'ACTIONS</p>
                    <input type="text" class="calc-input" placeholder="Oui/Non">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="L'entreprise d√©pend-elle d'un seul produit ou client ?">LE CHIFFRE D'AFFAIRES DE LA SOCI√âT√â EST DIVERSIFI√â</p>
                    <input type="text" class="calc-input" placeholder="Oui/Non">
                </div>
            </div>
        </div>
    
        <div class="section" id="croissance">
            <h3 class="calculator-section">CROISSANCE</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Moyenne de croissance annuelle du chiffre d'affaires sur 10 ans.">CROISSANCE DU CHIFFRE D'AFFAIRES SUR 10 ANS</p>
                    <input type="number" class="calc-input" placeholder="Nombre d'ann√©es" min="0" max="10">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Croissance du B√©n√©fice Par Action (EPS).">CROISSANCE DU B√âN√âFICE PAR ACTION SUR 10 ANS</p>
                    <input type="number" class="calc-input" placeholder="Nombre d'ann√©es" min="0" max="10">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Le Free Cash Flow est l'argent r√©el qui reste dans la poche.">CROISSANCE DU FREE CASH FLOW SUR 10 ANS</p>
                    <input type="number" class="calc-input" placeholder="Nombre d'ann√©es" min="0" max="10">
                </div>
            </div>
        </div>

        <div class="section" id="rentabilit√©">
            <h3 class="calculator-section">RENTABILIT√â</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Pourcentage de chiffre d'affaires transform√© en b√©n√©fice net.">MARGE NETTE</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Pourcentage de chiffre d'affaires transform√© en cash flow libre.">FCF MARGIN</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Return on Invested Capital.">ROIC</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" step="0.01">
                </div>
            </div>
        </div>

        <div class="section" id="solvabilit√©">
            <h3 class="calculator-section">SOLVABILIT√â</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Ratio dette/EBITDA.">DEBT-TO-EBITDA</p>
                    <input type="number" class="calc-input" placeholder="En nombre flottant" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Ratio dette/capitaux propres.">DEBT-TO-EQUITY</p>
                    <input type="number" class="calc-input" placeholder="En nombre flottant" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Couverture des int√©r√™ts.">COUVERTURE DES INT√âR√äTS</p>
                    <input type="number" class="calc-input" placeholder="En nombre flottant" step="0.01">
                </div>
            </div>
        </div>

        <div class="section" id="dividende">
            <h3 class="calculator-section">DIVIDENDE</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Part des b√©n√©fices revers√©e en dividende.">PAYOUT RATIO</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" min="0"  step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Part du Free Cash Flow utilis√©e pour payer le dividende.">PAYOUT RATIO DU FCF</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Croissance moyenne du dividende sur 5 ans.">CROISSANCE SUR 5 ANS</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" min="0" step="0.01">
                </div>
            </div>
        </div>

        <div class="section" id="valorisation">
            <h3 class="calculator-section">VALORISATION</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">PRIX JUSTE GURUFOCUS</p>
                    <input type="number" id="gurufocusPrice" placeholder="En nombre flottant" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">PRIX JUSTE TIPSRANKS</p>
                    <input type="number" id="tipsrankPrice" placeholder="En nombre flottant" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">PER HISTORIQUE 10 ANS</p>
                    <input type="number" id="historicalPER" placeholder="En nombre flottant" min="0" step="0.01">
                </div>
            </div>
        </div>

        <button class="calculator-button">G√©n√©rer l'Analyse</button>

        <div id="progress-container-circle" style="display: none;">
            <circle-progress id="circular-progress" max="30" value="0"></circle-progress>
            <p class="score-text" id="score-text">Le score total de votre action est de 0 sur 30 !</p>
        </div>

        <div id="radar-chart-container" style="display: none; align-items: center;">
            <canvas id="radarChart"></canvas>
        </div>

        <div id="bar-chart-container" style="display: none; align-items: center;">
            <canvas id="priceChart"></canvas>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home">Int√©r√™ts Compos√©s üöÄ</h2>
        <p class="calculator-text-home" style="margin-bottom: 30px;">Projetez vos gains futurs ! Voyez comment votre √©pargne fructifie ann√©e apr√®s ann√©e gr√¢ce √† la magie des int√©r√™ts compos√©s.</p>

        <div class="section section-interest" id="compound-calculator">
            <h3 class="calculator-section">PARAM√àTRES DE L'INVESTISSEMENT</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Combien comptez-vous investir chaque ann√©e ?">MONTANT ANNUEL D√âPOS√â (‚Ç¨/$)</p>
                    <input type="number" id="compound-deposit" class="compound-input" placeholder="Ex: 12000" min="0">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Pendant combien d'ann√©es allez-vous investir ?">DUR√âE (ANN√âES)</p>
                    <input type="number" id="compound-years" class="compound-input" placeholder="Ex: 20" min="1" max="100">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Quel rendement annuel moyen esp√©rez-vous ? (La bourse fait ~8-10% historiquement)">RENDEMENT ANNUEL (%)</p>
                    <input type="number" id="compound-rate" class="compound-input" placeholder="Ex: 8" step="0.1">
                </div>
            </div>
        </div>

        <button class="calculator-button" id="btn-compound-calc">Calculer les Int√©r√™ts</button>

        <div id="compound-results-container" style="display:none;">
            <div class="result-box">
                Dans <span id="res-years" style="font-weight:bold;">0</span> ans, vous aurez : <br>
                <span id="res-total" class="result-highlight">0 ‚Ç¨</span> <br>
                <span style="font-size: 0.9rem; color: #7f8c8d;">Dont <span id="res-invested" style="font-weight:bold;">0 ‚Ç¨</span> de votre poche et <span id="res-interests" style="font-weight:bold; color: #f39c12;">0 ‚Ç¨</span> d'int√©r√™ts gagn√©s.</span>
            </div>

            <div id="compound-chart-container" style="display: flex; align-items: center; margin-top: 30px; height: 400px;">
                <canvas id="compoundChart"></canvas>
            </div>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home">Estimateur DCF üíé</h2>
        <p class="calculator-text-home">
            Une entreprise de qualit√© ne doit pas √™tre achet√©e √† n'importe quel prix. Ce calculateur projette les b√©n√©fices futurs pour estimer un prix d'achat rationnel aujourd'hui, en fonction du rendement que vous exigez.
        </p>

        <div class="section section-dcf"> 
            <h3 class="calculator-section">PARAM√àTRES DE VALORISATION</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Le B√©n√©fice Par Action actuel (EPS TTM).">EPS ACTUEL (‚Ç¨/$)</p>
                    <input type="number" id="dcf-eps" class="calc-input" placeholder="Ex: 5.40" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="√Ä quelle vitesse les b√©n√©fices vont-ils cro√Ætre par an sur 5 ans ?">CROISSANCE ESTIM√âE (%)</p>
                    <input type="number" id="dcf-growth" class="calc-input" placeholder="Ex: 12">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Quel sera le PER raisonnable de l'action dans 5 ans ?">PER DE SORTIE</p>
                    <input type="number" id="dcf-pe" class="calc-input" placeholder="Ex: 20">
                </div>
            </div>
            
            <div class="input-container input-container-center">
                 <div class="input-group input-group-half">
                    <p class="label-text" data-tooltip="Quel rendement annuel minimum exigez-vous ? (souvent 10% ou 12%)">TAUX D'ACTUALISATION (%)</p>
                    <input type="number" id="dcf-discount" class="calc-input" placeholder="Ex: 10">
                </div>
            </div>
        </div>

        <button class="calculator-button" id="btn-dcf-calc">Calculer la Juste Valeur</button>

        <div id="dcf-result-container" class="result-box result-box-hidden">
            Prix d'achat maximum conseill√© : <br>
            <span id="dcf-fair-value" class="result-highlight">0 ‚Ç¨</span> <br>
            <span class="result-future-text">
                Si vous achetez √† ce prix, vous visez un objectif de <span id="dcf-future-price" style="font-weight: bold;">0 ‚Ç¨</span> dans 5 ans.
            </span>
            
            <div id="dcf-chart-container" class="chart-wrapper chart-height-large">
                <canvas id="dcfChart"></canvas>
            </div>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home">Simulateur de DCA üìâ</h2>
        <p class="calculator-text-home">
            Vous souhaitez renforcer une position existante ? Ce calculateur vous permet de voir instantan√©ment l'impact d'un nouvel achat sur votre Prix de Revient Unitaire (PRU). Id√©al pour la strat√©gie de "Moyenne √† la baisse".
        </p>

        <div class="section section-pru"> 
            <h3 class="calculator-section">VOTRE POSITION</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">ACTIONS D√âJ√Ä D√âTENUES</p>
                    <input type="number" id="pru-owned-shares" class="calc-input" placeholder="Ex: 10" min="0">
                </div>
                <div class="input-group">
                    <p class="label-text">PRIX D'ACHAT MOYEN (‚Ç¨/$)</p>
                    <input type="number" id="pru-avg-price" class="calc-input" placeholder="Ex: 150" step="0.01">
                </div>
            </div>
            
            <h3 class="calculator-section spacer-top">NOUVEL ACHAT</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">ACTIONS √Ä ACHETER</p>
                    <input type="number" id="pru-new-shares" class="calc-input" placeholder="Ex: 5" min="0">
                </div>
                <div class="input-group">
                    <p class="label-text">PRIX ACTUEL (‚Ç¨/$)</p>
                    <input type="number" id="pru-current-price" class="calc-input" placeholder="Ex: 130" step="0.01">
                </div>
            </div>
        </div>

        <button class="calculator-button" id="btn-pru-calc">Calculer mon Nouveau PRU</button>

        <div id="pru-results-container" class="result-box result-box-hidden">
            Votre nouveau prix de revient sera de : <br>
            <span id="res-new-pru" class="result-highlight">0 ‚Ç¨</span> <br>
            <span class="result-future-text">
                Vous d√©tiendrez <span id="res-total-shares" style="font-weight:bold;">0</span> actions pour un total investi de <span id="res-total-invested">0 ‚Ç¨</span>.
            </span>
            
            <div id="pru-chart-container" class="chart-wrapper chart-height-medium">
                <canvas id="pruChart"></canvas>
            </div>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home">Le Ratio PEG (Peter Lynch) ü¶Ñ</h2>
        <p class="calculator-text-home">
            Le PER seul ne suffit pas. Le ratio PEG met en relation le prix de l'action et sa croissance future. C'est l'outil favori des investisseurs pour d√©nicher les "Growth Stocks" √† prix raisonnable.
        </p>

        <div class="section section-peg"> 
            <h3 class="calculator-section">ANALYSE DU PRIX VS CROISSANCE</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Le PER actuel de l'entreprise.">PER ACTUEL</p>
                    <input type="number" id="peg-pe" class="calc-input" placeholder="Ex: 25">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Taux de croissance annuel moyen des b√©n√©fices (EPS) estim√© sur 3-5 ans.">CROISSANCE ATTENDUE (%)</p>
                    <input type="number" id="peg-growth" class="calc-input" placeholder="Ex: 20">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Optionnel : Rendement du dividende (Yield). Peter Lynch l'ajoute √† la croissance.">DIVIDENDE YIELD (%)</p>
                    <input type="number" id="peg-dividend" class="calc-input" placeholder="Ex: 1.5">
                </div>
            </div>
        </div>

        <button class="calculator-button" id="btn-peg-calc">Calculer le PEG</button>

        <div id="peg-results-container" class="result-box result-box-hidden">
            Ratio PEG Calcul√© : <br>
            <span id="res-peg-score" class="result-highlight peg-score-big">0.00</span> <br>
            <span id="res-peg-verdict" class="peg-verdict-text">Verdict</span>
            <p class="peg-legend">
                <span class="text-green">‚óè < 1.0 : Sous-√©valu√©</span> &nbsp;|&nbsp; 
                <span class="text-orange">‚óè 1.0 - 1.5 : Prix Correct</span> &nbsp;|&nbsp; 
                <span class="text-red">‚óè > 2.0 : Sur√©valu√©</span>
            </p>
            
            <div class="peg-bar-container">
                <div id="peg-bar-fill" class="peg-bar-fill"></div>
                <div class="peg-bar-marker marker-33" title="PEG 1.0"></div>
                <div class="peg-bar-marker marker-66" title="PEG 2.0"></div>
            </div>
        </div>

    </div>

    <div class="footer">
        <div class="copyright">
            <img src="./media/Logo/Logo-Black.png" alt="Logo QualityInvest">
            <span id="copyright-text" ><a href="https://x.com/StocksPickeur" class="reset-link">StocksPickeur &copy; 2025</a></span>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-circle-progress/dist/circle-progress.min.js" type="module"></script>

<script>

    // --- VARIABLES GLOBALES ---
    var totalScore = 0;
    var basisScore = 0;
    var growthScore = 0;
    var profitabilityScore = 0;
    var solvencyScore = 0;
    var dividendScore = 0;

    var currentTicker = "AAPL"; 
    var currentStockPrice = null;
    var fairPrice = 0;
    var currentPERatio = null;
    var gurufocusPrice = 0;
    var tipsrankPrice = 0;
    var safetyMargin = 0.1;

    // Cl√© API Finnhub
    const FINNHUB_API_KEY = 'cfeip41r01qoicaf4hk0cfeip41r01qoicaf4hkg';

    var sectionName = ["Bases","Croissance","Rentabilit√©","Solvabilit√©","Dividende"];
    let radarChartInstance = null;
    let priceChartInstance = null;

    // --- UTILITAIRES ---
    function isValidNumber(value) {
        return !isNaN(value) && value !== null && value !== '';
    }

    function updatePrices() {
        gurufocusPrice = parseFloat(document.getElementById('gurufocusPrice').value) || 0;
        tipsrankPrice = parseFloat(document.getElementById('tipsrankPrice').value) || 0;
    }

    function updateSafetyMarginDisplay(value) {
        const marginValues = [0, 5, 10, 15, 20, 30, 50]; 
        const marginValue = marginValues[value];
        document.getElementById('safetyMarginValue').textContent = marginValue;
        return marginValue / 100;
    }

    // --- API ---
    async function getStockPrice(symbol) {
        try {
            const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`);
            const data = await response.json();
            if (data && data.c) { return data.c; }
            return null;
        } catch (error) {
            console.error('Erreur API Prix:', error);
            return null;
        }
    }

    async function getPERatio(symbol) {
        try {
            const response = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=valuation&token=${FINNHUB_API_KEY}`);
            const data = await response.json();
            if (data.metric && data.metric.peNormalizedAnnual) {
                return parseFloat(data.metric.peNormalizedAnnual.toFixed(2));
            }
            return null;
        } catch (error) {
            console.error('Erreur API PE:', error);
            return null;
        }
    }

    // --- CALCULS SCORE ---
    function getData() {
        const inputs = document.querySelectorAll('.calc-input');
        const inputValues = [];
        inputs.forEach(input => inputValues.push(input.value.trim()));
        return inputValues;
    }

    function calculateBasis(inputValues){
        var beatsINX = inputValues[0].toLowerCase();
        var shareBuyback = inputValues[1].toLowerCase();
        var diversifiedCA = inputValues[2].toLowerCase();
        if (beatsINX == 'oui') { totalScore += 2; basisScore += 2; }
        if (shareBuyback == 'oui') { totalScore += 2; basisScore += 2; }
        if (diversifiedCA == 'oui') { totalScore += 2; basisScore += 2; }
        return basisScore;
    }

    function calculateGrowth(inputValues){
        var CAGrowth = parseFloat(inputValues[3]);
        var EPSGrowth = parseFloat(inputValues[4]);
        var FCFGrowth = parseFloat(inputValues[5]);
        if (CAGrowth > 7) { totalScore += 2; growthScore += 2; }
        if (EPSGrowth > 7) { totalScore += 2; growthScore += 2; }
        if (FCFGrowth > 7) { totalScore += 2; growthScore += 2; }
        return growthScore;
    }

    function calculateProfitability(inputValues){
        var netMargin = parseFloat(inputValues[6]);
        var fcfMargin = parseFloat(inputValues[7]);
        var roic = parseFloat(inputValues[8]);
        if (netMargin >= 35) { totalScore += 2; profitabilityScore += 2; }
        else if (netMargin >= 20) { totalScore += 1; profitabilityScore += 1; }
        if (fcfMargin >= 35) { totalScore += 2; profitabilityScore += 2; }
        else if (fcfMargin >= 20) { totalScore += 1; profitabilityScore += 1; }
        if (roic >= 30) { totalScore += 2; profitabilityScore += 2; }
        else if (roic >= 15) { totalScore += 1; profitabilityScore += 1; }
        return profitabilityScore;
    }

    function calculateSolvency(inputValues) {
        var debtToEBITDA = parseFloat(inputValues[9]);
        var debtToEquity = parseFloat(inputValues[10]);
        var interestCoverageRatio = parseFloat(inputValues[11]);
        if (isValidNumber(debtToEBITDA)) {
            if (debtToEBITDA < 1) { totalScore += 2; solvencyScore += 2; }
            else if (debtToEBITDA < 2) { totalScore += 1; solvencyScore += 1; }
        }
        if (isValidNumber(debtToEquity)) {
            if (debtToEquity < 1) { totalScore += 2; solvencyScore += 2; }
            else if (debtToEquity < 2) { totalScore += 1; solvencyScore += 1; }
        }
        if (isValidNumber(interestCoverageRatio)) {
            if (interestCoverageRatio >= 30) { totalScore += 2; solvencyScore += 2; }
            else if (interestCoverageRatio >= 15) { totalScore += 1; solvencyScore += 1; }
        }
        return solvencyScore;
    }

    function calculateDividend(inputValues) {
        var payoutRatio = parseFloat(inputValues[12]);
        var payoutRatioFCF = parseFloat(inputValues[13]);
        var dividendGrowth = parseFloat(inputValues[14]);
        if (isValidNumber(payoutRatio)) {
            if (payoutRatio < 30) { totalScore += 2; dividendScore += 2; }
            else if (payoutRatio < 50) { totalScore += 1; dividendScore += 1; }
        }
        if (isValidNumber(payoutRatioFCF)) {
            if (payoutRatioFCF < 30) { totalScore += 2; dividendScore += 2; }
            else if (payoutRatioFCF < 50) { totalScore += 1; dividendScore += 1; }
        }
        if (isValidNumber(dividendGrowth)) {
            if (dividendGrowth >= 10) { totalScore += 2; dividendScore += 2; }
            else if (dividendGrowth >= 5) { totalScore += 1; dividendScore += 1; }
        }
        return dividendScore;
    }

    function getFairPrice(gurufocusPrice, tipsrankPrice, safetyMargin) {
        const averagePrice = (gurufocusPrice + tipsrankPrice) / 2;
        fairPrice = averagePrice * (1 - safetyMargin);
        return fairPrice;
    }

    // --- GRAPHIQUES SCORE ---
    function createRadarChart(sectionScores) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (radarChartInstance) {
            radarChartInstance.data.datasets[0].data = sectionScores;
            radarChartInstance.update();
        } else {
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: sectionName,
                    datasets: [{
                        label: 'Score par Section',
                        data: sectionScores,
                        backgroundColor: 'rgba(53, 162, 235, 0.2)',
                        borderColor: 'rgba(53, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false }, title: { display: true, text: "ScoreCard de l'Action", font: { size: 16 } } },
                    scales: { r: { min: 0, max: 6, ticks: { stepSize: 1 } } },
                    elements: { line: { tension: 0 } }
                }
            });
        }
    }

    function createFairPriceChart(currentPrice, fairPrice) {
        const chartLabels = [currentTicker]; 
        const currentPriceData = [currentPrice];
        const fairPriceData = [fairPrice];
        const guruData = [gurufocusPrice];
        const tipsData = [tipsrankPrice];

        const ctx = document.getElementById('priceChart').getContext('2d');

        if (priceChartInstance) {
            priceChartInstance.data.labels = chartLabels;
            priceChartInstance.data.datasets[0].data = currentPriceData;
            priceChartInstance.data.datasets[1].data = fairPriceData;
            priceChartInstance.data.datasets[2].data = guruData;
            priceChartInstance.data.datasets[3].data = tipsData;
            priceChartInstance.update();
        } else {   
            priceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: "Prix Actuel",
                            type: 'bar',
                            data: currentPriceData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        },
                        {
                            label: "Prix Juste (Calcul√©)",
                            type: 'bar',
                            data: fairPriceData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                        },
                        {
                            label: "Prix GuruFocus",
                            type: 'line',
                            data: guruData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            tension: 0.2,
                            pointRadius: 8
                        },
                        {
                            label: "Prix TipsRank",
                            type: 'line',
                            data: tipsData,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 2,
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            fill: false,
                            tension: 0.2,
                            pointRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { display: true, text: "Comparaison des Prix", font: { size: 16 } }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }

    // --- EVENTS SCORE ---
    document.getElementById('gurufocusPrice').addEventListener('input', updatePrices);
    document.getElementById('tipsrankPrice').addEventListener('input', updatePrices);
    const slider = document.getElementById('safetyMarginSlider');
    slider.addEventListener('input', function() { safetyMargin = updateSafetyMarginDisplay(parseInt(this.value)); });
    slider.value = 2; 
    safetyMargin = updateSafetyMarginDisplay(2);

    document.getElementById('stockTicker').addEventListener('keypress', async function(e) {
        if (e.key === 'Enter') {
            const ticker = this.value.trim().toUpperCase();
            if (ticker) {
                this.placeholder = 'Chargement...';
                currentTicker = ticker;
                const price = await getStockPrice(ticker);
                const pe = await getPERatio(ticker);
                if (price) {
                    currentStockPrice = price;
                    currentPERatio = pe;
                    this.placeholder = `${ticker} charg√© (${price}$)`;
                } else {
                    this.placeholder = 'Erreur r√©cup√©ration prix';
                }
            }
        }
    });

    document.querySelector('.calculator-button').addEventListener('click', async function () {
        const tickerInput = document.getElementById('stockTicker');
        const tickerInputVal = tickerInput.value.trim().toUpperCase();

        if (tickerInputVal && (tickerInputVal !== currentTicker || currentStockPrice === null)) {
            currentTicker = tickerInputVal;
            tickerInput.placeholder = "Chargement...";
            const fetchedPrice = await getStockPrice(currentTicker);
            const fetchedPE = await getPERatio(currentTicker);
            if (fetchedPrice) {
                currentStockPrice = fetchedPrice;
                currentPERatio = fetchedPE;
                tickerInput.placeholder = `${currentTicker} charg√© (${fetchedPrice}$)`;
            }
        }

        if (currentStockPrice === null) currentStockPrice = 0;

        totalScore = 0; basisScore = 0; growthScore = 0; profitabilityScore = 0; solvencyScore = 0; dividendScore = 0;

        const inputValues = getData();
        calculateBasis(inputValues);
        calculateGrowth(inputValues);
        calculateProfitability(inputValues);
        calculateSolvency(inputValues);
        calculateDividend(inputValues);

        getFairPrice(gurufocusPrice, tipsrankPrice, safetyMargin);
        
        var sectionScores = [basisScore,growthScore,profitabilityScore,solvencyScore,dividendScore];

        const progressContainer = document.getElementById('progress-container-circle');
        progressContainer.style.display = 'block';
        const circleProgress = document.getElementById('circular-progress');
        circleProgress.setAttribute('value', totalScore); 
        circleProgress.setAttribute('max', 30); 
        const scoreText = document.getElementById('score-text');
        scoreText.textContent = `Le score de Qualit√© de votre action est de ${totalScore} sur 30 !`;

        document.getElementById('radar-chart-container').style.display = 'flex';
        createRadarChart(sectionScores);
        document.getElementById('bar-chart-container').style.display = 'flex';
        createFairPriceChart(currentStockPrice, fairPrice);
    });


    // ==========================================
    //       SCRIPT INT√âR√äTS COMPOS√âS (NOUVEAU)
    // ==========================================
    
    let compoundChartInstance = null;

    document.getElementById('btn-compound-calc').addEventListener('click', function() {
        // 1. R√©cup√©ration des valeurs
        const annualDeposit = parseFloat(document.getElementById('compound-deposit').value) || 0;
        const years = parseFloat(document.getElementById('compound-years').value) || 0;
        const rate = parseFloat(document.getElementById('compound-rate').value) || 0;

        if (years <= 0) {
            alert("Veuillez entrer une dur√©e valide (au moins 1 an).");
            return;
        }

        // 2. Calculs et pr√©paration des donn√©es pour le graphique
        const labels = [];
        const dataTotal = [];
        const dataInvested = [];
        
        let currentTotal = 0;
        let totalInvested = 0;

        for (let i = 1; i <= years; i++) {
            // On ajoute l'argent au d√©but de l'ann√©e (hypoth√®se simplifi√©e)
            totalInvested += annualDeposit;
            
            // On calcule les int√©r√™ts sur (Capital pr√©c√©dent + Nouveau d√©p√¥t)
            currentTotal = (currentTotal + annualDeposit) * (1 + (rate / 100));
            
            labels.push(`Ann√©e ${i}`);
            dataTotal.push(currentTotal);
            dataInvested.push(totalInvested);
        }

        const totalInterests = currentTotal - totalInvested;

        // 3. Affichage des r√©sultats textes (Format Mon√©taire)
        const formatter = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
        
        document.getElementById('res-years').textContent = years;
        document.getElementById('res-total').textContent = formatter.format(currentTotal);
        document.getElementById('res-invested').textContent = formatter.format(totalInvested);
        document.getElementById('res-interests').textContent = formatter.format(totalInterests);

        document.getElementById('compound-results-container').style.display = 'block';

        // 4. Cr√©ation / Mise √† jour du graphique
        const ctx = document.getElementById('compoundChart').getContext('2d');

        if (compoundChartInstance) {
            compoundChartInstance.destroy(); // On d√©truit l'ancien pour recr√©er proprement
        }

        compoundChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Capital Investi (Vos d√©p√¥ts)',
                        data: dataInvested,
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        fill: true,
                        pointRadius: 0,
                        borderWidth: 2
                    },
                    {
                        label: 'Valeur Totale (Avec Int√©r√™ts)',
                        data: dataTotal,
                        borderColor: 'rgba(46, 204, 113, 1)',
                        backgroundColor: 'rgba(46, 204, 113, 0.2)', // Vert
                        fill: true, // Remplit l'espace sous la courbe
                        pointRadius: 0,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Croissance de votre portefeuille',
                        font: { size: 16 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('fr-FR') + ' ‚Ç¨';
                            }
                        }
                    }
                }
            }
        });

        // Scroll vers les r√©sultats
        document.getElementById('compound-results-container').scrollIntoView({ behavior: 'smooth' });
    });

    // ==========================================
    //       SCRIPT DCF SIMPLIFI√â & GRAPHIQUE
    // ==========================================
    
    let dcfChartInstance = null; // Variable pour stocker le graphique

    document.getElementById('btn-dcf-calc').addEventListener('click', function() {
        // 1. R√©cup√©ration
        const epsInput = document.getElementById('dcf-eps').value;
        const growthInput = document.getElementById('dcf-growth').value;
        const peInput = document.getElementById('dcf-pe').value;
        const discountInput = document.getElementById('dcf-discount').value;

        if (epsInput === "" || growthInput === "" || peInput === "" || discountInput === "") {
            alert("Veuillez remplir tous les champs du calculateur DCF.");
            return;
        }

        const eps = parseFloat(epsInput);
        const growthRate = parseFloat(growthInput) / 100;
        const terminalPE = parseFloat(peInput);
        const discountRate = parseFloat(discountInput) / 100;

        // 2. Calculs
        // EPS Futur (dans 5 ans) = EPS Actuel * (1 + croissance)^5
        let futureEPS = eps * Math.pow((1 + growthRate), 5);
        
        // Prix Futur (dans 5 ans) = EPS Futur * PER de sortie
        let futurePrice = futureEPS * terminalPE;

        // Prix Juste (Aujourd'hui) = Prix Futur ramen√© √† aujourd'hui (Actualisation)
        let fairValue = futurePrice / Math.pow((1 + discountRate), 5);

        // 3. Affichage Texte
        const formatter = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });
        document.getElementById('dcf-fair-value').textContent = formatter.format(fairValue);
        // J'ai ajout√© l'affichage du prix futur dans le HTML, on le met √† jour ici :
        if(document.getElementById('dcf-future-price')) {
            document.getElementById('dcf-future-price').textContent = formatter.format(futurePrice);
        }
        
        const resContainer = document.getElementById('dcf-result-container');
        resContainer.style.display = 'block';

        // 4. G√©n√©ration des donn√©es pour le Graphique (Trajectoire de l'investissement)
        const labels = ['Aujourd\'hui', 'Ann√©e 1', 'Ann√©e 2', 'Ann√©e 3', 'Ann√©e 4', 'Ann√©e 5'];
        const dataValues = [];

        // On calcule la valeur th√©orique de l'investissement ann√©e par ann√©e
        // Si on ach√®te au "Prix Juste", l'investissement doit grandir au rythme du "Taux d'actualisation"
        for (let i = 0; i <= 5; i++) {
            let valueAtYear = fairValue * Math.pow((1 + discountRate), i);
            dataValues.push(valueAtYear);
        }

        // 5. Cr√©ation du Graphique
        const ctx = document.getElementById('dcfChart').getContext('2d');

        if (dcfChartInstance) {
            dcfChartInstance.destroy();
        }

        dcfChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Trajectoire de Valeur Th√©orique',
                    data: dataValues,
                    borderColor: 'rgba(155, 89, 182, 1)', // Couleur Violette
                    backgroundColor: 'rgba(155, 89, 182, 0.2)',
                    fill: true,
                    tension: 0.3, // Courbe l√©g√®rement arrondie
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Objectif : ${formatter.format(futurePrice)} dans 5 ans`,
                        font: { size: 16 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatter.format(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false, // On ne commence pas √† 0 pour mieux voir la progression
                        ticks: {
                            callback: function(value) { return value + ' ‚Ç¨'; }
                        }
                    }
                }
            }
        });

        resContainer.scrollIntoView({ behavior: 'smooth' });
    });

    // ==========================================
    //       SCRIPT SIMULATEUR PRU (DCA)
    // ==========================================
    
    let pruChartInstance = null;

    document.getElementById('btn-pru-calc').addEventListener('click', function() {
        // 1. R√©cup√©ration
        const ownedShares = parseFloat(document.getElementById('pru-owned-shares').value);
        const avgPrice = parseFloat(document.getElementById('pru-avg-price').value);
        const newShares = parseFloat(document.getElementById('pru-new-shares').value);
        const currentPrice = parseFloat(document.getElementById('pru-current-price').value);

        if (isNaN(ownedShares) || isNaN(avgPrice) || isNaN(newShares) || isNaN(currentPrice)) {
            alert("Veuillez remplir tous les champs du simulateur.");
            return;
        }

        // 2. Calculs
        const oldTotalValue = ownedShares * avgPrice;
        const newBuyValue = newShares * currentPrice;
        
        const totalShares = ownedShares + newShares;
        const totalInvested = oldTotalValue + newBuyValue;
        
        const newPRU = totalInvested / totalShares;
        
        // Diff√©rence en pourcentage
        const reduction = ((avgPrice - newPRU) / avgPrice) * 100;

        // --- GESTION DES COULEURS ---
        // Si le PRU baisse (reduction > 0) -> VERT, sinon -> ROUGE
        let resultColor, chartBarColor, chartBorderColor;

        if (newPRU < avgPrice) {
            // C'est positif (Baisse du PRU) -> VERT
            resultColor = '#27ae60'; // Vert fonc√© pour le texte
            chartBarColor = 'rgba(46, 204, 113, 0.8)'; // Vert clair pour le graphe
            chartBorderColor = 'rgba(46, 204, 113, 1)';
        } else {
            // C'est n√©gatif (Hausse du PRU) -> ROUGE
            resultColor = '#c0392b'; // Rouge fonc√© pour le texte
            chartBarColor = 'rgba(231, 76, 60, 0.8)'; // Rouge clair pour le graphe
            chartBorderColor = 'rgba(231, 76, 60, 1)';
        }

        // 3. Affichage Texte
        const formatter = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });
        
        const resPruElement = document.getElementById('res-new-pru');
        resPruElement.textContent = formatter.format(newPRU);
        resPruElement.style.color = resultColor; // Applique la couleur au texte

        document.getElementById('res-total-shares').textContent = totalShares;
        document.getElementById('res-total-invested').textContent = formatter.format(totalInvested);

        const resContainer = document.getElementById('pru-results-container');
        resContainer.style.display = 'block';

        // 4. Graphique Comparatif
        const ctx = document.getElementById('pruChart').getContext('2d');

        if (pruChartInstance) {
            pruChartInstance.destroy();
        }

        pruChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ancien Prix Moyen', 'Nouveau Prix Moyen (PRU)'],
                datasets: [{
                    label: 'Prix par Action',
                    data: [avgPrice, newPRU],
                    backgroundColor: [
                        'rgba(149, 165, 166, 0.5)', // Gris (Ancien, reste neutre)
                        chartBarColor               // DYNAMIQUE (Vert ou Rouge)
                    ],
                    borderColor: [
                        'rgba(149, 165, 166, 1)',
                        chartBorderColor            // DYNAMIQUE
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { 
                        display: true, 
                        text: reduction > 0 
                            ? `Bravo ! Vous avez baiss√© votre PRU de ${reduction.toFixed(2)}%` 
                            : `Attention : Votre PRU a augment√© de ${Math.abs(reduction).toFixed(2)}%`,
                        font: { size: 14 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatter.format(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true, 
                        ticks: { callback: function(value) { return value + ' ‚Ç¨'; } }
                    }
                }
            }
        });

        resContainer.scrollIntoView({ behavior: 'smooth' });
    });

    // ==========================================
    //       SCRIPT CALCULATEUR PEG
    // ==========================================
    document.getElementById('btn-peg-calc').addEventListener('click', function() {
        // 1. R√©cup√©ration
        const pe = parseFloat(document.getElementById('peg-pe').value);
        let growth = parseFloat(document.getElementById('peg-growth').value);
        const dividend = parseFloat(document.getElementById('peg-dividend').value) || 0;

        if (isNaN(pe) || isNaN(growth)) {
            alert("Veuillez entrer au moins le PER et la Croissance.");
            return;
        }

        // Peter Lynch Adjustment : On ajoute le dividende √† la croissance pour √™tre plus pr√©cis
        // Formule : PEG = PER / (Croissance + Dividende)
        const totalGrowth = growth + dividend;
        
        if (totalGrowth <= 0) {
            alert("La croissance totale doit √™tre positive pour calculer un PEG coh√©rent.");
            return;
        }

        const peg = pe / totalGrowth;

        // 2. Interpr√©tation & Couleurs
        let verdict = "";
        let color = "";
        let barWidth = 0; // Pour la barre visuelle (Max 3.0 = 100%)

        if (peg < 1) {
            verdict = "Action Sous-√©valu√©e (Aubaine Potentielle)";
            color = "#27ae60"; // Vert
        } else if (peg < 1.5) {
            verdict = "Action Valoris√©e Correctement (Fair Price)";
            color = "#f1c40f"; // Jaune/Or (Note: j'ai chang√© f39c12 en f1c40f pour plus de visibilit√©)
            // Correction pour contraste si besoin, ou on garde le jaune orang√© #f39c12
            if(peg >= 1) color = "#f39c12"; 
        } else if (peg < 2) {
            verdict = "Action L√©g√®rement Sur√©valu√©e";
            color = "#e67e22"; // Orange
        } else {
            verdict = "Action Tr√®s Sur√©valu√©e (Expensive)";
            color = "#c0392b"; // Rouge
        }

        // Calcul largeur barre (On dit que PEG 3.0 = 100% de la barre pour l'√©chelle)
        // PEG 1.0 = 33%, PEG 2.0 = 66%
        let widthPercentage = (peg / 3) * 100;
        if (widthPercentage > 100) widthPercentage = 100;

        // 3. Affichage
        const scoreElement = document.getElementById('res-peg-score');
        scoreElement.textContent = peg.toFixed(2);
        scoreElement.style.color = color;

        const verdictElement = document.getElementById('res-peg-verdict');
        verdictElement.textContent = verdict;
        verdictElement.style.color = color;

        const barFill = document.getElementById('peg-bar-fill');
        barFill.style.width = widthPercentage + "%";
        barFill.style.backgroundColor = color;

        const resContainer = document.getElementById('peg-results-container');
        resContainer.style.display = 'block';
        resContainer.scrollIntoView({ behavior: 'smooth' });
    });

</script>

</body>
</html>