<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateurs üìä</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" href="media/Logo/logo.ico" type="image/x-icon">
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-5QFGNT3V2F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5QFGNT3V2F');
</script>

<body>
    <header>
        <a href="../index.html" class="logo-title-link">
            <img src="../media/Logo/Logo-White.png" alt="Logo QualityInvest">
            <h1 class="header-title">StocksPickeur</h1>
        </a>
        <div class="onglets">
            <a href="calculator.html">Calculateur</a>
            <a href="wallet.html">Portefeuille</a>
            <a href="formation.html">Formation</a>
        </div>
    </header>

    <div class="calculator-home">

        <h2 class="title-home">Score de Qualit√© üìä</h2>
        <p class="calculator-text-home">Bienvenue sur mon outil de calcul du score de qualit√© d‚Äôune action ! Ce calcul repose sur une analyse approfondie de 15 crit√®res financiers et strat√©giques sp√©cifiques, qui permettent d‚Äô√©valuer solidit√©,croissance et rentabilit√© d‚Äôune action. Chaque crit√®re est pond√©r√© et contribue √† un score global sur 30 points. <br> Ce score vous permettra de mieux comprendre les forces et faiblesses d‚Äôune action afin de prendre des d√©cisions d‚Äôinvestissement plus √©clair√©es. Ce sont les 15 crit√®res que j'utilise √† l'heure actuelle pour analyser mes propres actions. Vous pouvez retrouver le score des actions de mon portefeuille ici : <a class="link-to-wallet" href="pages//wallet.html#quality">Score de qualit√© des actions de mon Portefeuille ‚öîÔ∏è</a> <br>Des questions sur les crit√®res que j'utilise ? rends-toi sur <a href="/pages/resources.html" class="link-to-wallet">la page Ressources</a> </p>
        <div class="ticker-input-container">
            <input type="text" id="stockTicker" class="ticker-input" placeholder="Entrez le ticker (ex: AAPL)" autocomplete="off">
            <div class="safety-margin-container">
                <label>Marge de s√©curit√©: <span id="safetyMarginValue">10</span>%</label>
                <div class="slider-container">
                    <div class="slider-track">
                        <div class="slider-fill"></div>
                        <input type="range" min="0" max="6" value="2" step="1" class="slider" list="markers" id="safetyMarginSlider">
                        <div class="slider-marks">
                            <span class="mark" style="left: 0%">0%</span>
                            <span class="mark" style="left: 16.66%">5%</span>
                            <span class="mark" style="left: 33.33%">10%</span>
                            <span class="mark" style="left: 50%">15%</span>
                            <span class="mark" style="left: 66.66%">20%</span>
                            <span class="mark" style="left: 83.33%">30%</span>
                            <span class="mark" style="left: 100%">50%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section" id="bases">
            <h3 class="calculator-section">BASES</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="V√©rifie si l'action a perform√© mieux que l'indice S&P 500 sur les 5 derni√®res ann√©es.">COURS DE L'ACTION BATS LE S&P500 SUR 5 ANS</p>
                    <input type="text" class="calc-input" placeholder="Oui/Non">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="L'entreprise rach√®te-t-elle ses propres actions ?">L'ENTREPRISE EFFECTUE DES RACHATS D'ACTIONS</p>
                    <input type="text" class="calc-input" placeholder="Oui/Non">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="L'entreprise d√©pend-elle d'un seul produit ou client ?">LE CHIFFRE D'AFFAIRES EST DIVERSIFI√â</p>
                    <input type="text" class="calc-input" placeholder="Oui/Non">
                </div>
            </div>
        </div>
    
        <div class="section" id="croissance">
            <h3 class="calculator-section">CROISSANCE</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">CROISSANCE DU CA SUR 10 ANS</p>
                    <input type="number" class="calc-input" placeholder="Nombre d'ann√©es" min="0" max="10">
                </div>
                <div class="input-group">
                    <p class="label-text">CROISSANCE DU BPA SUR 10 ANS</p>
                    <input type="number" class="calc-input" placeholder="Nombre d'ann√©es" min="0" max="10">
                </div>
                <div class="input-group">
                    <p class="label-text">CROISSANCE DU FCF SUR 10 ANS</p>
                    <input type="number" class="calc-input" placeholder="Nombre d'ann√©es" min="0" max="10">
                </div>
            </div>
        </div>

        <div class="section" id="rentabilit√©">
            <h3 class="calculator-section">RENTABILIT√â</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">MARGE NETTE</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">FCF MARGIN</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">ROIC</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" step="0.01">
                </div>
            </div>
        </div>

        <div class="section" id="solvabilit√©">
            <h3 class="calculator-section">SOLVABILIT√â</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">DEBT-TO-EBITDA</p>
                    <input type="number" class="calc-input" placeholder="En nombre flottant" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">DEBT-TO-EQUITY</p>
                    <input type="number" class="calc-input" placeholder="En nombre flottant" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">COUVERTURE INT√âR√äTS</p>
                    <input type="number" class="calc-input" placeholder="En nombre flottant" step="0.01">
                </div>
            </div>
        </div>

        <div class="section" id="dividende">
            <h3 class="calculator-section">DIVIDENDE</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">PAYOUT RATIO</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" min="0"  step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">PAYOUT RATIO DU FCF</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">CROISSANCE SUR 5 ANS</p>
                    <input type="number" class="calc-input" placeholder="En pourcentage (%)" min="0" step="0.01">
                </div>
            </div>
        </div>

        <div class="section" id="valorisation">
            <h3 class="calculator-section">VALORISATION</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">PRIX JUSTE GURUFOCUS</p>
                    <input type="number" id="gurufocusPrice" placeholder="En nombre flottant" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">PRIX JUSTE TIPSRANKS</p>
                    <input type="number" id="tipsrankPrice" placeholder="En nombre flottant" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text">PER HISTORIQUE 10 ANS</p>
                    <input type="number" id="historicalPER" placeholder="En nombre flottant" min="0" step="0.01">
                </div>
            </div>
        </div>

        <button class="calculator-button">G√©n√©rer l'Analyse</button>

        <div id="progress-container-circle" style="display: none;">
            <circle-progress id="circular-progress" max="30" value="0"></circle-progress>
            <p class="score-text" id="score-text">Le score total de votre action est de 0 sur 30 !</p>
        </div>

        <div id="radar-chart-container" style="display: none; align-items: center;">
            <canvas id="radarChart"></canvas>
        </div>

        <div id="bar-chart-container" style="display: none; align-items: center;">
            <canvas id="priceChart"></canvas>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home" id="interest">Int√©r√™ts Compos√©s üöÄ</h2>
        <div class="section section-interest" id="compound-calculator">
            <h3 class="calculator-section">PARAM√àTRES DE L'INVESTISSEMENT</h3>
            <div class="input-container">
                <div class="input-group input-group-half">
                    <p class="label-text">CAPITAL DE D√âPART</p>
                    <input type="number" id="compound-initial" class="compound-input" placeholder="Ex: 5000" min="0">
                </div>
                <div class="input-group input-group-half">
                    <p class="label-text">AJOUT ANNUEL</p>
                    <input type="number" id="compound-deposit" class="compound-input" placeholder="Ex: 12000" min="0">
                </div>
            </div>
            <div class="spacer-top"></div>
            <div class="input-container">
                <div class="input-group input-group-half">
                    <p class="label-text">DUR√âE (ANN√âES)</p>
                    <input type="number" id="compound-years" class="compound-input" placeholder="Ex: 20" min="1" max="100">
                </div>
                <div class="input-group input-group-half">
                    <p class="label-text">RENDEMENT ANNUEL (%)</p>
                    <input type="number" id="compound-rate" class="compound-input" placeholder="Ex: 8" step="0.1">
                </div>
            </div>
        </div>
        <button class="calculator-button" id="btn-compound-calc">Calculer les Int√©r√™ts</button>
        <div id="compound-results-container" style="display:none;">
            <div class="result-box">
                Dans <span id="res-years" style="font-weight:bold;">0</span> ans, vous aurez : <br>
                <span id="res-total" class="result-highlight">0 ‚Ç¨</span> <br>
                <span style="font-size: 0.9rem; color: #7f8c8d;">Dont <span id="res-invested" style="font-weight:bold;">0 ‚Ç¨</span> de votre poche et <span id="res-interests" style="font-weight:bold; color: #f39c12;">0 ‚Ç¨</span> d'int√©r√™ts gagn√©s.</span>
            </div>
            <div id="compound-chart-container" style="display: flex; align-items: center; margin-top: 30px; height: 400px;">
                <canvas id="compoundChart"></canvas>
            </div>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home">Estimateur DCF Avanc√© üíé</h2>
        <p class="calculator-text-home">
            Entrez le ticker en haut de page pour r√©cup√©rer le prix actuel, puis remplissez les donn√©es manuellement (en Milliards pour les gros chiffres).
        </p>

        <div class="section section-dcf"> 
            <h3 class="calculator-section">DONN√âES DU MARCH√â & PAR ACTION</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text" data-tooltip="Prix actuel de l'action.">PRIX ACTUEL DU MARCH√â</p>
                    <input type="number" id="dcf-market-price" class="calc-input" placeholder="Automatique" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Free Cash Flow par action (TTM).">FCF / ACTION</p>
                    <input type="number" id="dcf-fcf-share" class="calc-input" placeholder="Ex: 5.40" step="0.01">
                </div>
                <div class="input-group">
                    <p class="label-text" data-tooltip="Nombre total d'actions en circulation (en Milliards).">NBRE ACTIONS (Mds)</p>
                    <input type="number" id="dcf-shares" class="calc-input" placeholder="Ex: 2.5" step="0.001">
                </div>
            </div>

            <h3 class="calculator-section spacer-top">BILAN (EN MILLIARDS)</h3>
            <div class="input-container">
                <div class="input-group input-group-half">
                    <p class="label-text" data-tooltip="Cash & √âquivalents total (en Milliards).">CASH TOTAL (Mds)</p>
                    <input type="number" id="dcf-cash" class="calc-input" placeholder="Ex: 10.5" step="0.01">
                </div>
                <div class="input-group input-group-half">
                    <p class="label-text" data-tooltip="Dette Totale (Long terme + Court terme) en Milliards.">DETTE TOTALE (Mds)</p>
                    <input type="number" id="dcf-debt" class="calc-input" placeholder="Ex: 5.2" step="0.01">
                </div>
            </div>
            
            <h3 class="calculator-section spacer-top">VOS HYPOTH√àSES (5 ANS)</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">CROISSANCE FCF (%)</p>
                    <input type="number" id="dcf-growth" class="calc-input" placeholder="Ex: 12">
                </div>
                <div class="input-group">
                    <p class="label-text">TAUX D'ACTUALISATION (%)</p>
                    <input type="number" id="dcf-discount" class="calc-input" placeholder="Ex: 10">
                </div>
                <div class="input-group">
                    <p class="label-text">PER DE SORTIE</p>
                    <input type="number" id="dcf-exit-pe" class="calc-input" placeholder="Ex: 20">
                </div>
            </div>
        </div>

        <button class="calculator-button" id="btn-dcf-calc">Calculer la Juste Valeur</button>

        <div id="dcf-result-container" class="result-box-hidden"> 
            <div class="dcf-summary-box">
                <span style="font-size: 1.2em; color: #2c3e50;">Juste Valeur (Intrinsic Value) :</span><br>
                <span id="dcf-fair-value" class="result-highlight" style="display: block; margin: 10px 0;">$0.00</span>
                
                <div style="font-size: 1.1em; margin-top: 10px;">
                    <span style="color: #7f8c8d;">Marge de s√©curit√© :</span> 
                    <span id="dcf-margin-safety" style="font-weight: bold;">0%</span> 
                    <span style="margin: 0 15px; color: #ccc;">|</span>
                    <span style="color: #7f8c8d;">Potentiel :</span> 
                    <span id="dcf-upside" style="font-weight: bold;">0%</span>
                </div>
            </div>

            <div class="matrix-section">
                <h4 class="matrix-title">Matrice de Sensibilit√© (Prix Juste)</h4>
                <p class="matrix-subtitle">Colonnes : Croissance FCF | Lignes : Taux d'actualisation</p>
                <div class="matrix-container">
                    <table id="sensitivity-table" class="sensitivity-table"></table>
                </div>
            </div>

            <div class="chart-section">
                <h4 class="matrix-title" style="text-align: center;">Projection Valeur vs Prix (5 ans)</h4>
                <div class="chart-wrapper" style="height: 350px;">
                    <canvas id="dcfChart"></canvas>
                </div>
            </div>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home">Simulateur de DCA üìâ</h2>
        <div class="section section-pru"> 
            <h3 class="calculator-section">VOTRE POSITION</h3>
            <div class="input-container">
                <div class="input-group input-group-half">
                    <p class="label-text">ACTIONS D√âJ√Ä D√âTENUES</p>
                    <input type="number" id="pru-owned-shares" class="calc-input" placeholder="Ex: 10" min="0">
                </div>
                <div class="input-group input-group-half">
                    <p class="label-text">PRIX D'ACHAT MOYEN (‚Ç¨/$)</p>
                    <input type="number" id="pru-avg-price" class="calc-input" placeholder="Ex: 150" step="0.01">
                </div>
            </div>
            <h3 class="calculator-section spacer-top">NOUVEL ACHAT</h3>
            <div class="input-container">
                <div class="input-group input-group-half">
                    <p class="label-text">ACTIONS √Ä ACHETER</p>
                    <input type="number" id="pru-new-shares" class="calc-input" placeholder="Ex: 5" min="0">
                </div>
                <div class="input-group input-group-half">
                    <p class="label-text">PRIX ACTUEL (‚Ç¨/$)</p>
                    <input type="number" id="pru-current-price" class="calc-input" placeholder="Ex: 130" step="0.01">
                </div>
            </div>
        </div>
        <button class="calculator-button" id="btn-pru-calc">Calculer mon Nouveau PRU</button>
        <div id="pru-results-container" class="result-box result-box-hidden">
            Votre nouveau prix de revient sera de : <br>
            <span id="res-new-pru" class="result-highlight">0 ‚Ç¨</span> <br>
            <span class="result-future-text">
                Vous d√©tiendrez <span id="res-total-shares" style="font-weight:bold;">0</span> actions pour un total investi de <span id="res-total-invested">0 ‚Ç¨</span>.
            </span>
            <div id="pru-chart-container" class="chart-wrapper" style="height: 300px;">
                <canvas id="pruChart"></canvas>
            </div>
        </div>

        <div class="separator-line"></div>

        <h2 class="title-home">Le Ratio PEG (Peter Lynch) ü¶Ñ</h2>
        <div class="section section-peg"> 
            <h3 class="calculator-section">ANALYSE DU PRIX VS CROISSANCE</h3>
            <div class="input-container">
                <div class="input-group">
                    <p class="label-text">PER ACTUEL</p>
                    <input type="number" id="peg-pe" class="calc-input" placeholder="Ex: 25">
                </div>
                <div class="input-group">
                    <p class="label-text">CROISSANCE ATTENDUE</p>
                    <input type="number" id="peg-growth" class="calc-input" placeholder="Ex: 20">
                </div>
                <div class="input-group">
                    <p class="label-text">DIVIDENDE YIELD</p>
                    <input type="number" id="peg-dividend" class="calc-input" placeholder="Ex: 1.5">
                </div>
            </div>
        </div>
        <button class="calculator-button" id="btn-peg-calc">Calculer le PEG</button>
        <div id="peg-results-container" class="result-box result-box-hidden">
            Ratio PEG Calcul√© : <br>
            <span id="res-peg-score" class="result-highlight peg-score-big">0.00</span> <br>
            <span id="res-peg-verdict" class="peg-verdict-text">Verdict</span>
            <p class="peg-legend">
                <span class="text-green">‚óè < 1.0 : Sous-√©valu√©</span> &nbsp;|&nbsp; 
                <span class="text-orange">‚óè 1.0 - 1.5 : Prix Correct</span> &nbsp;|&nbsp; 
                <span class="text-red">‚óè > 2.0 : Sur√©valu√©</span>
            </p>
            <div class="peg-bar-container">
                <div id="peg-bar-fill" class="peg-bar-fill"></div>
                <div class="peg-bar-marker marker-33" title="PEG 1.0"></div>
                <div class="peg-bar-marker marker-66" title="PEG 2.0"></div>
            </div>
        </div>

    </div>

    <div class="footer">
        <div class="copyright">
            <img src="../media/Logo/Logo-Black.png" alt="Logo QualityInvest">
            <span id="copyright-text" ><a href="https://x.com/StocksPickeur" class="reset-link">StocksPickeur &copy; 2025</a></span>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-circle-progress/dist/circle-progress.min.js" type="module"></script>

<script>

    // --- VARIABLES GLOBALES ---
    var totalScore = 0;
    var basisScore = 0;
    var growthScore = 0;
    var profitabilityScore = 0;
    var solvencyScore = 0;
    var dividendScore = 0;

    var currentTicker = "AAPL"; 
    var currentStockPrice = null;
    var fairPrice = 0;
    var currentPERatio = null;
    var gurufocusPrice = 0;
    var tipsrankPrice = 0;
    var safetyMargin = 0.1;

    const FINNHUB_API_KEY = 'cfeip41r01qoicaf4hk0cfeip41r01qoicaf4hkg';

    var sectionName = ["Bases","Croissance","Rentabilit√©","Solvabilit√©","Dividende"];
    let radarChartInstance = null;
    let priceChartInstance = null;

    // --- UTILITAIRES ---
    function isValidNumber(value) {
        return !isNaN(value) && value !== null && value !== '';
    }

    function updatePrices() {
        gurufocusPrice = parseFloat(document.getElementById('gurufocusPrice').value) || 0;
        tipsrankPrice = parseFloat(document.getElementById('tipsrankPrice').value) || 0;
    }

    function updateSafetyMarginDisplay(value) {
        const marginValues = [0, 5, 10, 15, 20, 30, 50]; 
        const marginValue = marginValues[value];
        document.getElementById('safetyMarginValue').textContent = marginValue;
        return marginValue / 100;
    }

    // --- API ---
    async function getStockPrice(symbol) {
        try {
            const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`);
            const data = await response.json();
            if (data && data.c) { return data.c; }
            return null;
        } catch (error) {
            console.error('Erreur API Prix:', error);
            return null;
        }
    }

    async function getPERatio(symbol) {
        try {
            const response = await fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=valuation&token=${FINNHUB_API_KEY}`);
            const data = await response.json();
            if (data.metric && data.metric.peNormalizedAnnual) {
                return parseFloat(data.metric.peNormalizedAnnual.toFixed(2));
            }
            return null;
        } catch (error) {
            console.error('Erreur API PE:', error);
            return null;
        }
    }

    // --- CALCULS SCORE (Quality) ---
    function getData() {
        const inputs = document.querySelectorAll('.calc-input');
        const inputValues = [];
        inputs.forEach(input => inputValues.push(input.value.trim()));
        return inputValues;
    }

    function calculateBasis(inputValues){
        var beatsINX = inputValues[0].toLowerCase();
        var shareBuyback = inputValues[1].toLowerCase();
        var diversifiedCA = inputValues[2].toLowerCase();
        if (beatsINX == 'oui') { totalScore += 2; basisScore += 2; }
        if (shareBuyback == 'oui') { totalScore += 2; basisScore += 2; }
        if (diversifiedCA == 'oui') { totalScore += 2; basisScore += 2; }
        return basisScore;
    }

    function calculateGrowth(inputValues){
        var CAGrowth = parseFloat(inputValues[3]);
        var EPSGrowth = parseFloat(inputValues[4]);
        var FCFGrowth = parseFloat(inputValues[5]);
        if (CAGrowth > 7) { totalScore += 2; growthScore += 2; }
        if (EPSGrowth > 7) { totalScore += 2; growthScore += 2; }
        if (FCFGrowth > 7) { totalScore += 2; growthScore += 2; }
        return growthScore;
    }

    function calculateProfitability(inputValues){
        var netMargin = parseFloat(inputValues[6]);
        var fcfMargin = parseFloat(inputValues[7]);
        var roic = parseFloat(inputValues[8]);
        if (netMargin >= 35) { totalScore += 2; profitabilityScore += 2; }
        else if (netMargin >= 20) { totalScore += 1; profitabilityScore += 1; }
        if (fcfMargin >= 35) { totalScore += 2; profitabilityScore += 2; }
        else if (fcfMargin >= 20) { totalScore += 1; profitabilityScore += 1; }
        if (roic >= 30) { totalScore += 2; profitabilityScore += 2; }
        else if (roic >= 15) { totalScore += 1; profitabilityScore += 1; }
        return profitabilityScore;
    }

    function calculateSolvency(inputValues) {
        var debtToEBITDA = parseFloat(inputValues[9]);
        var debtToEquity = parseFloat(inputValues[10]);
        var interestCoverageRatio = parseFloat(inputValues[11]);
        if (isValidNumber(debtToEBITDA)) {
            if (debtToEBITDA < 1) { totalScore += 2; solvencyScore += 2; }
            else if (debtToEBITDA < 2) { totalScore += 1; solvencyScore += 1; }
        }
        if (isValidNumber(debtToEquity)) {
            if (debtToEquity < 1) { totalScore += 2; solvencyScore += 2; }
            else if (debtToEquity < 2) { totalScore += 1; solvencyScore += 1; }
        }
        if (isValidNumber(interestCoverageRatio)) {
            if (interestCoverageRatio >= 30) { totalScore += 2; solvencyScore += 2; }
            else if (interestCoverageRatio >= 15) { totalScore += 1; solvencyScore += 1; }
        }
        return solvencyScore;
    }

    function calculateDividend(inputValues) {
        var payoutRatio = parseFloat(inputValues[12]);
        var payoutRatioFCF = parseFloat(inputValues[13]);
        var dividendGrowth = parseFloat(inputValues[14]);
        if (isValidNumber(payoutRatio)) {
            if (payoutRatio < 30) { totalScore += 2; dividendScore += 2; }
            else if (payoutRatio < 50) { totalScore += 1; dividendScore += 1; }
        }
        if (isValidNumber(payoutRatioFCF)) {
            if (payoutRatioFCF < 30) { totalScore += 2; dividendScore += 2; }
            else if (payoutRatioFCF < 50) { totalScore += 1; dividendScore += 1; }
        }
        if (isValidNumber(dividendGrowth)) {
            if (dividendGrowth >= 10) { totalScore += 2; dividendScore += 2; }
            else if (dividendGrowth >= 5) { totalScore += 1; dividendScore += 1; }
        }
        return dividendScore;
    }

    function getFairPrice(gurufocusPrice, tipsrankPrice, safetyMargin) {
        const averagePrice = (gurufocusPrice + tipsrankPrice) / 2;
        fairPrice = averagePrice * (1 - safetyMargin);
        return fairPrice;
    }

    // --- GRAPHIQUES SCORE ---
    function createRadarChart(sectionScores) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if (radarChartInstance) {
            radarChartInstance.data.datasets[0].data = sectionScores;
            radarChartInstance.update();
        } else {
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: sectionName,
                    datasets: [{
                        label: 'Score par Section',
                        data: sectionScores,
                        backgroundColor: 'rgba(53, 162, 235, 0.2)',
                        borderColor: 'rgba(53, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false }, title: { display: true, text: "ScoreCard de l'Action", font: { size: 16 } } },
                    scales: { r: { min: 0, max: 6, ticks: { stepSize: 1 } } },
                    elements: { line: { tension: 0 } }
                }
            });
        }
    }

    function createFairPriceChart(currentPrice, fairPrice) {
        const chartLabels = [currentTicker]; 
        const currentPriceData = [currentPrice];
        const fairPriceData = [fairPrice];
        const guruData = [gurufocusPrice];
        const tipsData = [tipsrankPrice];

        const ctx = document.getElementById('priceChart').getContext('2d');

        if (priceChartInstance) {
            priceChartInstance.data.labels = chartLabels;
            priceChartInstance.data.datasets[0].data = currentPriceData;
            priceChartInstance.data.datasets[1].data = fairPriceData;
            priceChartInstance.data.datasets[2].data = guruData;
            priceChartInstance.data.datasets[3].data = tipsData;
            priceChartInstance.update();
        } else {   
            priceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: "Prix Actuel",
                            type: 'bar',
                            data: currentPriceData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2
                        },
                        {
                            label: "Prix Juste (Calcul√©)",
                            type: 'bar',
                            data: fairPriceData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                        },
                        {
                            label: "Prix GuruFocus",
                            type: 'line',
                            data: guruData,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            tension: 0.2,
                            pointRadius: 8
                        },
                        {
                            label: "Prix TipsRank",
                            type: 'line',
                            data: tipsData,
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 2,
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            fill: false,
                            tension: 0.2,
                            pointRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { display: true, text: "Comparaison des Prix", font: { size: 16 } }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }

    // --- EVENTS SCORE ---
    document.getElementById('gurufocusPrice').addEventListener('input', updatePrices);
    document.getElementById('tipsrankPrice').addEventListener('input', updatePrices);
    const slider = document.getElementById('safetyMarginSlider');
    slider.addEventListener('input', function() { safetyMargin = updateSafetyMarginDisplay(parseInt(this.value)); });
    slider.value = 2; 
    safetyMargin = updateSafetyMarginDisplay(2);

    document.getElementById('stockTicker').addEventListener('keypress', async function(e) {
        if (e.key === 'Enter') {
            const ticker = this.value.trim().toUpperCase();
            if (ticker) {
                this.placeholder = 'Chargement...';
                currentTicker = ticker;
                const price = await getStockPrice(ticker);
                const pe = await getPERatio(ticker);
                if (price) {
                    currentStockPrice = price;
                    currentPERatio = pe;
                    this.placeholder = `${ticker} charg√© (${price}$)`;
                    
                    const dcfPriceInput = document.getElementById('dcf-market-price');
                    if(dcfPriceInput) dcfPriceInput.value = price;

                } else {
                    this.placeholder = 'Erreur r√©cup√©ration prix';
                }
            }
        }
    });

    document.querySelector('.calculator-button').addEventListener('click', async function () {
        const tickerInput = document.getElementById('stockTicker');
        const tickerInputVal = tickerInput.value.trim().toUpperCase();

        if (tickerInputVal && (tickerInputVal !== currentTicker || currentStockPrice === null)) {
            currentTicker = tickerInputVal;
            tickerInput.placeholder = "Chargement...";
            const fetchedPrice = await getStockPrice(currentTicker);
            const fetchedPE = await getPERatio(currentTicker);
            if (fetchedPrice) {
                currentStockPrice = fetchedPrice;
                currentPERatio = fetchedPE;
                tickerInput.placeholder = `${currentTicker} charg√© (${fetchedPrice}$)`;
                
                const dcfPriceInput = document.getElementById('dcf-market-price');
                if(dcfPriceInput) dcfPriceInput.value = fetchedPrice;
            }
        }

        if (currentStockPrice === null) currentStockPrice = 0;

        totalScore = 0; basisScore = 0; growthScore = 0; profitabilityScore = 0; solvencyScore = 0; dividendScore = 0;

        const inputValues = getData();
        calculateBasis(inputValues);
        calculateGrowth(inputValues);
        calculateProfitability(inputValues);
        calculateSolvency(inputValues);
        calculateDividend(inputValues);

        getFairPrice(gurufocusPrice, tipsrankPrice, safetyMargin);
        
        var sectionScores = [basisScore,growthScore,profitabilityScore,solvencyScore,dividendScore];

        const progressContainer = document.getElementById('progress-container-circle');
        progressContainer.style.display = 'block';
        const circleProgress = document.getElementById('circular-progress');
        circleProgress.setAttribute('value', totalScore); 
        circleProgress.setAttribute('max', 30); 
        const scoreText = document.getElementById('score-text');
        scoreText.textContent = `Le score de Qualit√© de votre action est de ${totalScore} sur 30 !`;

        document.getElementById('radar-chart-container').style.display = 'flex';
        createRadarChart(sectionScores);
        document.getElementById('bar-chart-container').style.display = 'flex';
        createFairPriceChart(currentStockPrice, fairPrice);

        document.getElementById('progress-container-circle').scrollIntoView({ behavior: 'smooth'});
    });


    // ==========================================
    //       SCRIPT INT√âR√äTS COMPOS√âS
    // ==========================================
    let compoundChartInstance = null;

    document.getElementById('btn-compound-calc').addEventListener('click', function() {
        const initialCapital = parseFloat(document.getElementById('compound-initial').value) || 0;
        const annualDeposit = parseFloat(document.getElementById('compound-deposit').value) || 0;
        const years = parseFloat(document.getElementById('compound-years').value) || 0;
        const rate = parseFloat(document.getElementById('compound-rate').value) || 0;

        if (years <= 0) { alert("Dur√©e invalide."); return; }

        const labels = ['D√©part'];
        const dataTotal = [initialCapital];
        const dataInvested = [initialCapital];
        
        let currentTotal = initialCapital;
        let totalInvested = initialCapital;

        for (let i = 1; i <= years; i++) {
            totalInvested += annualDeposit;
            currentTotal = (currentTotal + annualDeposit) * (1 + (rate / 100));
            labels.push(`Ann√©e ${i}`);
            dataTotal.push(currentTotal);
            dataInvested.push(totalInvested);
        }

        const totalInterests = currentTotal - totalInvested;
        const formatter = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 });
        
        document.getElementById('res-years').textContent = years;
        document.getElementById('res-total').textContent = formatter.format(currentTotal);
        document.getElementById('res-invested').textContent = formatter.format(totalInvested);
        document.getElementById('res-interests').textContent = formatter.format(totalInterests);

        document.getElementById('compound-results-container').style.display = 'block';

        const ctx = document.getElementById('compoundChart').getContext('2d');
        if (compoundChartInstance) compoundChartInstance.destroy();

        compoundChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Capital Investi',
                        data: dataInvested,
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        fill: true, pointRadius: 0
                    },
                    {
                        label: 'Valeur Totale',
                        data: dataTotal,
                        borderColor: 'rgba(46, 204, 113, 1)',
                        backgroundColor: 'rgba(46, 204, 113, 0.2)',
                        fill: true, pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
        document.getElementById('compound-results-container').scrollIntoView({ behavior: 'smooth' });
    });

    // ==========================================
    //       SCRIPT DCF AVANC√â (CORRIG√â)
    // ==========================================
    
    let dcfChartInstance = null; 

    // Fonction Pure DCF
    function calculateIntrinsicValue(fcfShare, growthRate, discountRate, exitPE, netDebtPerShare) {
        let sumDiscountedFCF = 0;
        let futureFCF = fcfShare;
        
        for (let i = 1; i <= 5; i++) {
            futureFCF = futureFCF * (1 + growthRate);
            let discountedFCF = futureFCF / Math.pow((1 + discountRate), i);
            sumDiscountedFCF += discountedFCF;
        }

        let terminalValue = futureFCF * exitPE;
        let discountedTerminalValue = terminalValue / Math.pow((1 + discountRate), 5);
        let enterpriseValuePerShare = sumDiscountedFCF + discountedTerminalValue;

        return enterpriseValuePerShare - netDebtPerShare;
    }

    function getHeatmapColor(value, marketPrice) {
        const diff = (value - marketPrice) / marketPrice;
        if (diff >= 0.15) return 'rgba(46, 204, 113, 0.4)'; // Vert
        if (diff >= 0) return 'rgba(46, 204, 113, 0.2)';
        if (diff >= -0.15) return 'rgba(241, 196, 15, 0.3)'; // Jaune
        return 'rgba(231, 76, 60, 0.3)'; // Rouge
    }

    document.getElementById('btn-dcf-calc').addEventListener('click', function() {
        const priceInput = document.getElementById('dcf-market-price').value;
        const fcfShareInput = document.getElementById('dcf-fcf-share').value;
        const sharesInput = document.getElementById('dcf-shares').value;
        const cashInput = document.getElementById('dcf-cash').value;
        const debtInput = document.getElementById('dcf-debt').value;
        const growthInput = document.getElementById('dcf-growth').value;
        const discountInput = document.getElementById('dcf-discount').value;
        const exitPEInput = document.getElementById('dcf-exit-pe').value;

        if ([priceInput, fcfShareInput, sharesInput, cashInput, debtInput, growthInput, discountInput, exitPEInput].some(val => val === "")) {
            alert("Veuillez remplir tous les champs du calculateur DCF.");
            return;
        }

        const marketPrice = parseFloat(priceInput);
        const fcfPerShare = parseFloat(fcfShareInput);
        const sharesCount = parseFloat(sharesInput); 
        const totalCash = parseFloat(cashInput);     
        const totalDebt = parseFloat(debtInput);     
        const baseGrowthRate = parseFloat(growthInput) / 100;
        const baseDiscountRate = parseFloat(discountInput) / 100;
        const exitPE = parseFloat(exitPEInput);

        const netDebtPerShare = (totalDebt - totalCash) / sharesCount;

        // Calcul Principal
        let fairValue = calculateIntrinsicValue(fcfPerShare, baseGrowthRate, baseDiscountRate, exitPE, netDebtPerShare);

        // Calculs Annexes
        const marginOfSafety = ((fairValue - marketPrice) / fairValue) * 100;
        const upsidePotential = ((fairValue - marketPrice) / marketPrice) * 100;

        const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }); 
        
        const fairValueElement = document.getElementById('dcf-fair-value');
        fairValueElement.textContent = formatter.format(fairValue);
        fairValueElement.style.color = fairValue > marketPrice ? '#27ae60' : '#c0392b';

        const marginElement = document.getElementById('dcf-margin-safety');
        marginElement.textContent = marginOfSafety.toFixed(2) + "%";
        marginElement.style.color = marginOfSafety > 0 ? '#27ae60' : '#c0392b';

        const upsideElement = document.getElementById('dcf-upside');
        upsideElement.textContent = upsidePotential.toFixed(2) + "%";
        upsideElement.style.color = upsidePotential > 0 ? '#27ae60' : '#c0392b';
        
        const resContainer = document.getElementById('dcf-result-container');
        resContainer.style.display = 'block';

        // 6. GRAPHIQUE DE PROJECTION (LIGNE) - FORMULE CROISSANCE COMPOS√âE DIRECTE
        const labels = ['Aujourd\'hui', 'Ann√©e 1', 'Ann√©e 2', 'Ann√©e 3', 'Ann√©e 4', 'Ann√©e 5'];
        const intrinsicData = [];
        const priceData = Array(6).fill(marketPrice);

        // L'Ann√©e 0 (Aujourd'hui) est la Valeur Intrins√®que calcul√©e
        intrinsicData.push(Number(fairValue.toFixed(2)));

        // Pour les ann√©es suivantes, on applique : Prix(n) = Prix(n-1) * (1 + Croissance)
        for (let i = 1; i <= 5; i++) {
            let previousValue = intrinsicData[i - 1];
            let nextValue = previousValue * (1 + baseGrowthRate);
            intrinsicData.push(Number(nextValue.toFixed(2)));
        }

        const ctx = document.getElementById('dcfChart').getContext('2d');
        if (dcfChartInstance) dcfChartInstance.destroy();

        dcfChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Valeur Intrins√®que Projet√©e',
                        data: intrinsicData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        fill: true,
                        tension: 0.1 // Ligne quasi droite pour coller au Sheets
                    },
                    {
                        label: 'Prix Actuel',
                        data: priceData,
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: { callback: (value) => value + ' $' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });

        // 5. MATRICE DE SENSIBILIT√â (7x7) - AXES INVERS√âS
        const tableBody = document.getElementById('sensitivity-table');
        tableBody.innerHTML = ''; 

        const discountSteps = [-0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03];
        const growthSteps = [-0.03, -0.02, -0.01, 0, 0.01, 0.02, 0.03];

        // --- CHANGEMENT ICI : Header devient la Croissance ---
        let headerRow = document.createElement('tr');
        headerRow.appendChild(document.createElement('th')); // Coin vide
        
        // On boucle sur growthSteps pour l'en-t√™te
        growthSteps.forEach(step => {
            let th = document.createElement('th');
            th.textContent = ((baseGrowthRate + step) * 100).toFixed(0) + '%';
            headerRow.appendChild(th);
        });
        tableBody.appendChild(headerRow);

        // --- CHANGEMENT ICI : Lignes deviennent le Taux d'Actualisation ---
        discountSteps.forEach(dStep => {
            let tr = document.createElement('tr');
            
            // Premi√®re cellule de la ligne : Le taux d'actualisation
            let thDiscount = document.createElement('th');
            thDiscount.textContent = ((baseDiscountRate + dStep) * 100).toFixed(0) + '%';
            tr.appendChild(thDiscount);

            // On remplit les colonnes (Croissance)
            growthSteps.forEach(gStep => {
                let td = document.createElement('td');
                
                // Le calcul reste le m√™me, on passe juste les bons param√®tres
                let cellVal = calculateIntrinsicValue(
                    fcfPerShare, 
                    baseGrowthRate + gStep, // Croissance (Colonne)
                    baseDiscountRate + dStep, // Actualisation (Ligne)
                    exitPE, 
                    netDebtPerShare
                );
                
                td.textContent = cellVal.toFixed(1);
                td.style.backgroundColor = getHeatmapColor(cellVal, marketPrice);
                
                // Case centrale
                if (gStep === 0 && dStep === 0) td.classList.add('cell-current');
                tr.appendChild(td);
            });
            tableBody.appendChild(tr);
        });

        resContainer.scrollIntoView({ behavior: 'smooth' });
    });

    // ==========================================
    //       SCRIPT SIMULATEUR PRU
    // ==========================================
    let pruChartInstance = null;

    document.getElementById('btn-pru-calc').addEventListener('click', function() {
        const ownedShares = parseFloat(document.getElementById('pru-owned-shares').value);
        const avgPrice = parseFloat(document.getElementById('pru-avg-price').value);
        const newShares = parseFloat(document.getElementById('pru-new-shares').value);
        const currentPrice = parseFloat(document.getElementById('pru-current-price').value);

        if (isNaN(ownedShares) || isNaN(avgPrice) || isNaN(newShares) || isNaN(currentPrice)) { alert("Erreur saisie."); return; }

        const oldTotalValue = ownedShares * avgPrice;
        const newBuyValue = newShares * currentPrice;
        const totalShares = ownedShares + newShares;
        const totalInvested = oldTotalValue + newBuyValue;
        const newPRU = totalInvested / totalShares;
        const reduction = ((avgPrice - newPRU) / avgPrice) * 100;

        let chartBarColor = newPRU < avgPrice ? 'rgba(46, 204, 113, 0.8)' : 'rgba(231, 76, 60, 0.8)';
        
        const formatter = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });
        
        const resPruElement = document.getElementById('res-new-pru');
        resPruElement.textContent = formatter.format(newPRU);
        resPruElement.style.color = newPRU < avgPrice ? '#27ae60' : '#c0392b';

        document.getElementById('res-total-shares').textContent = totalShares;
        document.getElementById('res-total-invested').textContent = formatter.format(totalInvested);
        document.getElementById('pru-results-container').style.display = 'block';

        const ctx = document.getElementById('pruChart').getContext('2d');
        if (pruChartInstance) pruChartInstance.destroy();

        pruChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ancien Prix Moyen', 'Nouveau Prix Moyen (PRU)'],
                datasets: [{
                    label: 'Prix par Action',
                    data: [avgPrice, newPRU],
                    backgroundColor: ['rgba(149, 165, 166, 0.5)', chartBarColor],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
        document.getElementById('pru-results-container').scrollIntoView({ behavior: 'smooth' });
    });

    // ==========================================
    //       SCRIPT PEG
    // ==========================================
    document.getElementById('btn-peg-calc').addEventListener('click', function() {
        const pe = parseFloat(document.getElementById('peg-pe').value);
        let growth = parseFloat(document.getElementById('peg-growth').value);
        const dividend = parseFloat(document.getElementById('peg-dividend').value) || 0;

        if (isNaN(pe) || isNaN(growth)) { alert("Saisie invalide."); return; }

        const totalGrowth = growth + dividend;
        if (totalGrowth <= 0) { alert("Croissance doit √™tre positive."); return; }

        const peg = pe / totalGrowth;
        let verdict = "", color = "";

        if (peg < 1) { verdict = "Sous-√©valu√©e"; color = "#27ae60"; } 
        else if (peg < 1.5) { verdict = "Prix Correct"; color = "#f1c40f"; } 
        else if (peg < 2) { verdict = "L√©g√®rement Sur√©valu√©e"; color = "#e67e22"; } 
        else { verdict = "Tr√®s Sur√©valu√©e"; color = "#c0392b"; }

        let widthPercentage = (peg / 3) * 100;
        if (widthPercentage > 100) widthPercentage = 100;

        const scoreElement = document.getElementById('res-peg-score');
        scoreElement.textContent = peg.toFixed(2);
        scoreElement.style.color = color;

        document.getElementById('res-peg-verdict').textContent = verdict;
        document.getElementById('res-peg-verdict').style.color = color;
        document.getElementById('peg-bar-fill').style.width = widthPercentage + "%";
        document.getElementById('peg-bar-fill').style.backgroundColor = color;

        document.getElementById('peg-results-container').style.display = 'block';
        document.getElementById('peg-results-container').scrollIntoView({ behavior: 'smooth' });
    });

</script>

</body>
</html>